import * as React from 'react';
import { reaction } from 'mobx';
import * as uuid from 'uuid/v4';
import { ListenerFn } from 'eventemitter3';

import FocusStore from './FocusStore';
import { Gamepad } from './Gamepad';

const useFocus = (onGamepadEvent?: Function) => {
    const [isFocused, setFocus] = React.useState(false);
    const ref = React.useRef<HTMLElement>(null);

    React.useEffect(() => {
        const id = uuid();

        const gamepadHandler: ListenerFn = event => {
            if (FocusStore.focused === id) {
                onGamepadEvent ? onGamepadEvent(event) : null;
            }
        }

        FocusStore.gamepad.on('gamepadevent', gamepadHandler);

        reaction(
            () => FocusStore.focused,
            focusedId => focusedId === id ? setFocus(true) : setFocus(false)
        );

        FocusStore.addFocusable({
            boundingRect: ref.current.getBoundingClientRect() as DOMRect,
            id
        });

        return () => {
            FocusStore.removeFocusable(id);
            FocusStore.gamepad.removeListener('gamepadevent', gamepadHandler);
        }

    }, []);

    return {
        isFocused,
        ref
    }
}







export default {
    useFocus,
    Gamepad
}